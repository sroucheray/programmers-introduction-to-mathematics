<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Polynomial</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      output {
        display: block;
      }
    </style>
  </head>
  <body>
    <button type="button" id="clear">Clear</button>
    <canvas></canvas>
    <output id="coordinates"></output>
    <output id="result"></output>
  </body>
  <script type="module">
    import { interpolate } from '../dist/interpolate.js';

    function moveTo(context, x, y) {
      context.moveTo(x + 0.5, y + 0.5);
    }

    function lineTo(context, x, y) {
      context.lineTo(x + 0.5, y + 0.5);
    }

    function drawAbscise(canvas, context) {
      context.beginPath();
      moveTo(context, 0, canvas.height / 2);
      lineTo(context, canvas.width, canvas.height / 2);
      context.stroke();
    }

    function drawOrdinate(canvas, context) {
      context.beginPath();
      moveTo(context, canvas.width / 2, 0);
      lineTo(context, canvas.width / 2, canvas.height);
      context.stroke();
    }

    function getCanvasAbscise(x, y) {
      return x + canvas.width / 2;
    }

    function getCanvasOrdinate(y) {
      return y + canvas.height / 2;
    }

    function drawPoint(context, x, y) {
      const radius = 5;
      context.beginPath();
      context.arc(x, y, radius, 0, 2 * Math.PI);
      context.fill();
    }

    function getMouseCoordinates(x, y) {
      return {
        x: x - canvas.width / 2,
        y: y - canvas.height / 2,
      };
    }

    let points = [];

    function reset() {
      context.clearRect(0, 0, canvas.width, canvas.height);
      drawAbscise(canvas, context);
      drawOrdinate(canvas, context);
    }

    function addPoint({ x, y }) {
      reset();
      points.push([x, y]);
      for (const [x, y] of points) {
        drawPoint(context, getCanvasAbscise(x), getCanvasOrdinate(y));
      }

      if (points.length <= 1) {
        return;
      }

      try {
        const polynomial = interpolate(points);
        let previousPoint;
        context.beginPath();
        const from = Math.floor(-canvas.width / 2);
        const to = Math.ceil(canvas.width / 2);
        for (let index = from; index < to; index++) {
          if (previousPoint === undefined) {
            previousPoint = polynomial.evaluateAt(points);
            moveTo(
              context,
              getCanvasAbscise(index),
              getCanvasOrdinate(previousPoint)
            );
            continue;
          }

          const nextPoint = polynomial.evaluateAt(index);
          lineTo(
            context,
            getCanvasAbscise(index),
            getCanvasOrdinate(nextPoint)
          );
          previousPoint = nextPoint;
        }

        context.stroke();
        document.querySelector('#result').innerText = polynomial.toString();
      } catch (e) {
        console.log('Error', e);
        points.pop();
      }
    }

    const canvas = document.querySelector('canvas');
    const context = canvas.getContext('2d');
    context.strokeStyle = 'black';

    canvas.addEventListener('mousemove', (event) => {
      console.log(getMouseCoordinates(event.offsetX, event.offsetY));
      const { x, y } = getMouseCoordinates(event.offsetX, event.offsetY);
      document.querySelector('#coordinates').innerText = `[${x}, ${y}]`;
    });

    canvas.addEventListener('click', (event) => {
      addPoint(getMouseCoordinates(event.offsetX, event.offsetY));
    });

    document.getElementById('clear').addEventListener('click', (event) => {
      reset();
      points = [];
    });

    reset();
  </script>
</html>
